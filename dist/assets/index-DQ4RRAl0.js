var Nt=Object.defineProperty;var Tt=(e,t,n)=>t in e?Nt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Ve=(e,t,n)=>Tt(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))i(l);new MutationObserver(l=>{for(const o of l)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(l){const o={};return l.integrity&&(o.integrity=l.integrity),l.referrerPolicy&&(o.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?o.credentials="include":l.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(l){if(l.ep)return;l.ep=!0;const o=n(l);fetch(l.href,o)}})();function R(){}function St(e){return e()}function lt(){return Object.create(null)}function ne(e){e.forEach(St)}function Qe(e){return typeof e=="function"}function We(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}let Te;function ot(e,t){return e===t?!0:(Te||(Te=document.createElement("a")),Te.href=t,e===Te.href)}function Bt(e){return Object.keys(e).length===0}function Et(e,...t){if(e==null){for(const i of t)i(void 0);return R}const n=e.subscribe(...t);return n.unsubscribe?()=>n.unsubscribe():n}function He(e,t,n){e.$$.on_destroy.push(Et(t,n))}function w(e,t){e.appendChild(t)}function B(e,t,n){e.insertBefore(t,n||null)}function T(e){e.parentNode&&e.parentNode.removeChild(e)}function N(e){return document.createElement(e)}function H(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function ee(e){return document.createTextNode(e)}function $(){return ee(" ")}function oe(){return ee("")}function C(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}function Fe(e){return function(t){return t.stopPropagation(),e.call(this,t)}}function a(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function It(e){return e===""?null:+e}function Rt(e){return Array.from(e.childNodes)}function jt(e,t){t=""+t,e.data!==t&&(e.data=t)}function be(e,t){e.value=t??""}function b(e,t,n,i){n==null?e.style.removeProperty(t):e.style.setProperty(t,n,"")}function Ct(e,t,{bubbles:n=!1,cancelable:i=!1}={}){return new CustomEvent(e,{detail:t,bubbles:n,cancelable:i})}let Ee;function Se(e){Ee=e}function xe(){if(!Ee)throw new Error("Function called outside component initialization");return Ee}function Mt(e){xe().$$.on_mount.push(e)}function qt(e){xe().$$.on_destroy.push(e)}function Wt(){const e=xe();return(t,n,{cancelable:i=!1}={})=>{const l=e.$$.callbacks[t];if(l){const o=Ct(t,n,{cancelable:i});return l.slice().forEach(s=>{s.call(e,o)}),!o.defaultPrevented}return!0}}const we=[],Re=[];let ye=[];const st=[],Vt=Promise.resolve();let Ze=!1;function Ht(){Ze||(Ze=!0,Vt.then(Dt))}function Ge(e){ye.push(e)}const Ke=new Set;let pe=0;function Dt(){if(pe!==0)return;const e=Ee;do{try{for(;pe<we.length;){const t=we[pe];pe++,Se(t),Kt(t.$$)}}catch(t){throw we.length=0,pe=0,t}for(Se(null),we.length=0,pe=0;Re.length;)Re.pop()();for(let t=0;t<ye.length;t+=1){const n=ye[t];Ke.has(n)||(Ke.add(n),n())}ye.length=0}while(we.length);for(;st.length;)st.pop()();Ze=!1,Ke.clear(),Se(e)}function Kt(e){if(e.fragment!==null){e.update(),ne(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(Ge)}}function Xt(e){const t=[],n=[];ye.forEach(i=>e.indexOf(i)===-1?t.push(i):n.push(i)),n.forEach(i=>i()),ye=t}const Be=new Set;let ue;function De(){ue={r:0,c:[],p:ue}}function ze(){ue.r||ne(ue.c),ue=ue.p}function G(e,t){e&&e.i&&(Be.delete(e),e.i(t))}function te(e,t,n,i){if(e&&e.o){if(Be.has(e))return;Be.add(e),ue.c.push(()=>{Be.delete(e),i&&(n&&e.d(1),i())}),e.o(t)}else i&&i()}function je(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function zt(e,t){te(e,1,1,()=>{t.delete(e.key)})}function Lt(e,t,n,i,l,o,s,r,f,u,p,k){let d=e.length,m=o.length,_=d;const y={};for(;_--;)y[e[_].key]=_;const v=[],j=new Map,L=new Map,z=[];for(_=m;_--;){const g=k(l,o,_),S=n(g);let c=s.get(S);c?z.push(()=>c.p(g,t)):(c=u(S,g),c.c()),j.set(S,v[_]=c),S in y&&L.set(S,Math.abs(_-y[S]))}const U=new Set,Y=new Set;function D(g){G(g,1),g.m(r,p),s.set(g.key,g),p=g.first,m--}for(;d&&m;){const g=v[m-1],S=e[d-1],c=g.key,I=S.key;g===S?(p=g.first,d--,m--):j.has(I)?!s.has(c)||U.has(c)?D(g):Y.has(I)?d--:L.get(c)>L.get(I)?(Y.add(c),D(g)):(U.add(I),d--):(f(S,s),d--)}for(;d--;){const g=e[d];j.has(g.key)||f(g,s)}for(;m;)D(v[m-1]);return ne(z),v}function Ot(e){e&&e.c()}function $e(e,t,n){const{fragment:i,after_update:l}=e.$$;i&&i.m(t,n),Ge(()=>{const o=e.$$.on_mount.map(St).filter(Qe);e.$$.on_destroy?e.$$.on_destroy.push(...o):ne(o),e.$$.on_mount=[]}),l.forEach(Ge)}function et(e,t){const n=e.$$;n.fragment!==null&&(Xt(n.after_update),ne(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function Yt(e,t){e.$$.dirty[0]===-1&&(we.push(e),Ht(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function tt(e,t,n,i,l,o,s=null,r=[-1]){const f=Ee;Se(e);const u=e.$$={fragment:null,ctx:[],props:o,update:R,not_equal:l,bound:lt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(f?f.$$.context:[])),callbacks:lt(),dirty:r,skip_bound:!1,root:t.target||f.$$.root};s&&s(u.root);let p=!1;if(u.ctx=n?n(e,t.props||{},(k,d,...m)=>{const _=m.length?m[0]:d;return u.ctx&&l(u.ctx[k],u.ctx[k]=_)&&(!u.skip_bound&&u.bound[k]&&u.bound[k](_),p&&Yt(e,k)),d}):[],u.update(),p=!0,ne(u.before_update),u.fragment=i?i(u.ctx):!1,t.target){if(t.hydrate){const k=Rt(t.target);u.fragment&&u.fragment.l(k),k.forEach(T)}else u.fragment&&u.fragment.c();t.intro&&G(e.$$.fragment),$e(e,t.target,t.anchor),Dt()}Se(f)}class nt{constructor(){Ve(this,"$$");Ve(this,"$$set")}$destroy(){et(this,1),this.$destroy=R}$on(t,n){if(!Qe(n))return R;const i=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return i.push(n),()=>{const l=i.indexOf(n);l!==-1&&i.splice(l,1)}}$set(t){this.$$set&&!Bt(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const Jt="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Jt);const ge=[];function Ft(e,t){return{subscribe:ce(e,t).subscribe}}function ce(e,t=R){let n;const i=new Set;function l(r){if(We(e,r)&&(e=r,n)){const f=!ge.length;for(const u of i)u[1](),ge.push(u,e);if(f){for(let u=0;u<ge.length;u+=2)ge[u][0](ge[u+1]);ge.length=0}}}function o(r){l(r(e))}function s(r,f=R){const u=[r,f];return i.add(u),i.size===1&&(n=t(l,o)||R),r(e),()=>{i.delete(u),i.size===0&&n&&(n(),n=null)}}return{set:l,update:o,subscribe:s}}function Zt(e,t,n){const i=!Array.isArray(e),l=i?[e]:e;if(!l.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const o=t.length<2;return Ft(n,(s,r)=>{let f=!1;const u=[];let p=0,k=R;const d=()=>{if(p)return;k();const _=t(i?u[0]:u,s,r);o?s(_):k=Qe(_)?_:R},m=l.map((_,y)=>Et(_,v=>{u[y]=v,p&=~(1<<y),f&&d()},()=>{p|=1<<y}));return f=!0,d(),function(){ne(m),k(),f=!1}})}const me=ce("select"),Ie=ce([]),Me=ce(void 0),it=ce(0),Gt=ce(""),rt=ce(Date.now());Zt(Me,e=>!!e);function Qt(e,t){return{docId:e,image:void 0,layers:[{id:"layer-1",name:"Layer 1",visible:!0,zIndex:0,shapes:[]}],version:0,updatedAt:Date.now(),updatedBy:t.id}}function Xe(e){Ie.set(e.layers),Me.set(e.image),it.set(e.version),rt.set(e.updatedAt),Gt.set(e.updatedBy)}function xt(e,t){let n=[],i,l=0,o=Date.now();return Ie.subscribe(s=>n=s)(),Me.subscribe(s=>i=s)(),it.subscribe(s=>l=s)(),rt.subscribe(s=>o=s)(),{docId:e,image:i,layers:n,version:l,updatedAt:o,updatedBy:t}}function Ce(e){Ie.update(e),rt.set(Date.now())}function at(e,t){Ce(n=>n.map(i=>i.id===e?{...i,shapes:en(i.shapes,t)}:i))}function $t(e,t){Ce(n=>n.map(i=>i.id===e?{...i,shapes:i.shapes.filter(l=>l.id!==t)}:i))}function en(e,t){const n=e.findIndex(l=>l.id===t.id);if(n===-1)return[...e,t];const i=e.slice();return i[n]=t,i}async function tn(e,t=2560,n=.82){const i=new Image;i.src=URL.createObjectURL(e),await new Promise((p,k)=>{i.onload=()=>p(),i.onerror=()=>k(new Error("Image load failed"))});const l=Math.min(1,t/Math.max(i.width,i.height)),o=Math.round(i.width*l),s=Math.round(i.height*l),r=Object.assign(document.createElement("canvas"),{width:o,height:s}),f=r.getContext("2d");if(!f)throw new Error("Canvas context not available");f.drawImage(i,0,0,o,s);const u=r.toDataURL("image/jpeg",n);return URL.revokeObjectURL(i.src),{dataUrl:u,width:o,height:s}}function nn(e){let t,n;return{c(){t=document.createElementNS("http://www.w3.org/1999/xhtml","div"),n=ee(e[4]),b(t,"flex","1"),b(t,"white-space","pre-wrap"),b(t,"color",e[5]),b(t,"font-size",e[6]+"px"),b(t,"padding","6px")},m(i,l){B(i,t,l),w(t,n)},p(i,l){l&16&&jt(n,i[4]),l&32&&b(t,"color",i[5]),l&64&&b(t,"font-size",i[6]+"px")},d(i){i&&T(t)}}}function rn(e){let t,n,i;return{c(){t=document.createElementNS("http://www.w3.org/1999/xhtml","textarea"),b(t,"flex","1"),b(t,"resize","none"),b(t,"border","0"),b(t,"background","transparent"),b(t,"color",e[5]),b(t,"padding","6px"),b(t,"outline","none"),b(t,"font-size",e[6]+"px")},m(l,o){B(l,t,o),e[15](t),be(t,e[10]),n||(i=[C(t,"input",e[16]),C(t,"keydown",e[12]),C(t,"blur",e[13])],n=!0)},p(l,o){o&32&&b(t,"color",l[5]),o&64&&b(t,"font-size",l[6]+"px"),o&1024&&be(t,l[10])},d(l){l&&T(t),e[15](null),n=!1,ne(i)}}}function ft(e){let t,n,i,l,o,s,r,f,u,p,k;return{c(){t=H("g"),n=H("rect"),i=H("text"),l=ee(`Ã—
      `),s=H("g"),r=H("rect"),f=H("path"),a(n,"x",-12),a(n,"y",-2),a(n,"width",16),a(n,"height",16),a(n,"rx","3"),a(n,"ry","3"),a(n,"fill","#d9534f"),a(n,"stroke","#a94442"),b(n,"cursor","pointer"),a(i,"x",-8),a(i,"y",10),a(i,"fill","#fff"),a(i,"font-size","12"),a(i,"font-family","sans-serif"),b(i,"cursor","pointer"),b(i,"user-select","none"),a(t,"transform",o=`translate(${e[0]+(e[2]||200)-14}, ${e[1]+2})`),b(t,"pointer-events","auto"),a(r,"x",-6),a(r,"y",-6),a(r,"width",12),a(r,"height",12),a(r,"rx","2"),a(r,"ry","2"),a(r,"fill","#2f6feb"),a(r,"stroke","#1f4ed4"),b(r,"cursor","se-resize"),a(f,"d","M -2,-2 L 2,2 M 0,-2 L 2,0 M -2,0 L 0,2"),a(f,"stroke","white"),a(f,"stroke-width","1"),b(f,"pointer-events","none"),a(s,"transform",u=`translate(${e[0]+(e[2]||200)-8}, ${e[1]+(e[3]||60)-8})`),b(s,"pointer-events","auto")},m(d,m){B(d,t,m),w(t,n),w(t,i),w(i,l),B(d,s,m),w(s,r),w(s,f),p||(k=[C(n,"click",Fe(e[17])),C(i,"click",Fe(e[18])),C(r,"pointerdown",e[14])],p=!0)},p(d,m){m&7&&o!==(o=`translate(${d[0]+(d[2]||200)-14}, ${d[1]+2})`)&&a(t,"transform",o),m&15&&u!==(u=`translate(${d[0]+(d[2]||200)-8}, ${d[1]+(d[3]||60)-8})`)&&a(s,"transform",u)},d(d){d&&(T(t),T(s)),p=!1,ne(k)}}}function ln(e){let t,n,i,l,o,s,r,f,u,p;function k(y,v){return y[7]?rn:nn}let d=k(e),m=d(e),_=e[8]&&ft(e);return{c(){t=H("g"),n=H("rect"),o=H("foreignObject"),s=document.createElementNS("http://www.w3.org/1999/xhtml","div"),m.c(),_&&_.c(),a(n,"x",e[0]),a(n,"y",e[1]),a(n,"width",i=e[2]||200),a(n,"height",l=e[3]||60),a(n,"fill","white"),a(n,"stroke",e[5]),a(n,"rx","6"),a(n,"ry","6"),a(s,"xmlns","http://www.w3.org/1999/xhtml"),b(s,"width","100%"),b(s,"height","100%"),b(s,"display","flex"),a(o,"x",e[0]),a(o,"y",e[1]),a(o,"width",r=e[2]||200),a(o,"height",f=e[3]||60)},m(y,v){B(y,t,v),w(t,n),w(t,o),w(o,s),m.m(s,null),_&&_.m(t,null),u||(p=C(t,"click",Fe(e[19])),u=!0)},p(y,[v]){v&1&&a(n,"x",y[0]),v&2&&a(n,"y",y[1]),v&4&&i!==(i=y[2]||200)&&a(n,"width",i),v&8&&l!==(l=y[3]||60)&&a(n,"height",l),v&32&&a(n,"stroke",y[5]),d===(d=k(y))&&m?m.p(y,v):(m.d(1),m=d(y),m&&(m.c(),m.m(s,null))),v&1&&a(o,"x",y[0]),v&2&&a(o,"y",y[1]),v&4&&r!==(r=y[2]||200)&&a(o,"width",r),v&8&&f!==(f=y[3]||60)&&a(o,"height",f),y[8]?_?_.p(y,v):(_=ft(y),_.c(),_.m(t,null)):_&&(_.d(1),_=null)},i:R,o:R,d(y){y&&T(t),m.d(),_&&_.d(),u=!1,p()}}}function on(e,t,n){let{x:i=0}=t,{y:l=0}=t,{width:o=240}=t,{height:s=100}=t,{text:r=""}=t,{color:f="#ffffff"}=t,{fontSize:u=16}=t,{isEditing:p=!1}=t,{selected:k=!1}=t;const d=Wt();let m=null,_=r,y=!1,v=0,j=0,L=0,z=0;Mt(()=>{p&&m&&m.focus()});function U(E){(E.metaKey||E.ctrlKey)&&E.key==="Enter"&&d("save",{text:_.trim()})}function Y(){d("save",{text:_.trim()})}function D(E){E.stopPropagation(),y=!0,v=E.clientX,j=E.clientY,L=o,z=s;const q=E.target.closest("svg");q&&(q.addEventListener("pointermove",g),q.addEventListener("pointerup",S),q.setPointerCapture(E.pointerId))}function g(E){if(!y)return;const q=E.clientX-v,V=E.clientY-j,Q=Math.max(100,L+q),de=Math.max(40,z+V);d("resize",{width:Q,height:de})}function S(E){if(!y)return;y=!1;const q=E.target.closest("svg");q&&(q.removeEventListener("pointermove",g),q.removeEventListener("pointerup",S),q.releasePointerCapture(E.pointerId))}function c(E){Re[E?"unshift":"push"](()=>{m=E,n(9,m)})}function I(){_=this.value,n(10,_),n(7,p),n(4,r)}const P=()=>d("delete"),le=()=>d("delete"),se=()=>d("select");return e.$$set=E=>{"x"in E&&n(0,i=E.x),"y"in E&&n(1,l=E.y),"width"in E&&n(2,o=E.width),"height"in E&&n(3,s=E.height),"text"in E&&n(4,r=E.text),"color"in E&&n(5,f=E.color),"fontSize"in E&&n(6,u=E.fontSize),"isEditing"in E&&n(7,p=E.isEditing),"selected"in E&&n(8,k=E.selected)},e.$$.update=()=>{e.$$.dirty&144&&p&&n(10,_=r)},[i,l,o,s,r,f,u,p,k,m,_,d,U,Y,D,c,I,P,le,se]}class sn extends nt{constructor(t){super(),tt(this,t,on,ln,We,{x:0,y:1,width:2,height:3,text:4,color:5,fontSize:6,isEditing:7,selected:8})}}function ut(e,t,n){const i=e.slice();return i[51]=t[n],i}function ct(e,t,n){const i=e.slice();return i[54]=t[n],i}function dt(e){let t;return{c(){t=N("div"),t.textContent="Read-only: in use by another editor",a(t,"class","busy-banner svelte-1n3uqbm")},m(n,i){B(n,t,i)},d(n){n&&T(t)}}}function an(e){let t;return{c(){t=N("div"),t.textContent="No image loaded yet. Use the file picker above.",b(t,"padding","24px")},m(n,i){B(n,t,i)},p:R,i:R,o:R,d(n){n&&T(t)}}}function fn(e){let t,n,i,l,o,s,r,f,u=[],p=new Map,k,d,m,_,y,v,j,L,z=e[8]&&ht(e),U=je(e[1]);const Y=c=>c[51].id;for(let c=0;c<U.length;c+=1){let I=ut(e,U,c),P=Y(I);p.set(P,u[c]=gt(P,I))}let D=e[13]==="draw"&&e[5].length>0&&mt(e),g=e[13]==="arrow"&&e[6]&&e[7]&&wt(e),S=e[13]==="text"&&e[8]&&bt(e);return{c(){t=N("div"),n=N("img"),s=$(),r=H("svg"),z&&z.c(),f=oe();for(let c=0;c<u.length;c+=1)u[c].c();k=oe(),D&&D.c(),d=oe(),g&&g.c(),m=oe(),S&&S.c(),ot(n.src,i=e[0].dataUrl)||a(n,"src",i),a(n,"width",l=e[0].width),a(n,"height",o=e[0].height),a(n,"alt","Markup base"),b(n,"display","block"),b(n,"max-width","100%"),b(n,"height","auto"),a(r,"width",_=e[0].width),a(r,"height",y=e[0].height),b(r,"position","absolute"),b(r,"inset","0"),b(t,"display","inline-block"),b(t,"position","relative")},m(c,I){B(c,t,I),w(t,n),e[29](n),w(t,s),w(t,r),z&&z.m(r,null),w(r,f);for(let P=0;P<u.length;P+=1)u[P]&&u[P].m(r,null);w(r,k),D&&D.m(r,null),w(r,d),g&&g.m(r,null),w(r,m),S&&S.m(r,null),v=!0,j||(L=[C(r,"pointerdown",e[15]),C(r,"pointermove",e[16]),C(r,"pointerup",e[17])],j=!0)},p(c,I){(!v||I[0]&1&&!ot(n.src,i=c[0].dataUrl))&&a(n,"src",i),(!v||I[0]&1&&l!==(l=c[0].width))&&a(n,"width",l),(!v||I[0]&1&&o!==(o=c[0].height))&&a(n,"height",o),c[8]?z?z.p(c,I):(z=ht(c),z.c(),z.m(r,f)):z&&(z.d(1),z=null),I[0]&11786&&(U=je(c[1]),De(),u=Lt(u,I,Y,1,c,U,p,r,zt,gt,k,ut),ze()),c[13]==="draw"&&c[5].length>0?D?D.p(c,I):(D=mt(c),D.c(),D.m(r,d)):D&&(D.d(1),D=null),c[13]==="arrow"&&c[6]&&c[7]?g?g.p(c,I):(g=wt(c),g.c(),g.m(r,m)):g&&(g.d(1),g=null),c[13]==="text"&&c[8]?S?S.p(c,I):(S=bt(c),S.c(),S.m(r,null)):S&&(S.d(1),S=null),(!v||I[0]&1&&_!==(_=c[0].width))&&a(r,"width",_),(!v||I[0]&1&&y!==(y=c[0].height))&&a(r,"height",y)},i(c){if(!v){for(let I=0;I<U.length;I+=1)G(u[I]);v=!0}},o(c){for(let I=0;I<u.length;I+=1)te(u[I]);v=!1},d(c){c&&T(t),e[29](null),z&&z.d();for(let I=0;I<u.length;I+=1)u[I].d();D&&D.d(),g&&g.d(),S&&S.d(),j=!1,ne(L)}}}function ht(e){let t,n,i,l,o;return{c(){t=H("rect"),a(t,"x",n=e[8].x),a(t,"y",i=e[8].y),a(t,"width",l=e[8].w),a(t,"height",o=e[8].h),a(t,"fill","none"),a(t,"stroke",e[3]),a(t,"stroke-dasharray","4 4")},m(s,r){B(s,t,r)},p(s,r){r[0]&256&&n!==(n=s[8].x)&&a(t,"x",n),r[0]&256&&i!==(i=s[8].y)&&a(t,"y",i),r[0]&256&&l!==(l=s[8].w)&&a(t,"width",l),r[0]&256&&o!==(o=s[8].h)&&a(t,"height",o),r[0]&8&&a(t,"stroke",s[3])},d(s){s&&T(t)}}}function _t(e){let t=[],n=new Map,i,l,o=je(e[51].shapes);const s=r=>r[54].id;for(let r=0;r<o.length;r+=1){let f=ct(e,o,r),u=s(f);n.set(u,t[r]=pt(u,f))}return{c(){for(let r=0;r<t.length;r+=1)t[r].c();i=oe()},m(r,f){for(let u=0;u<t.length;u+=1)t[u]&&t[u].m(r,f);B(r,i,f),l=!0},p(r,f){f[0]&11786&&(o=je(r[51].shapes),De(),t=Lt(t,f,s,1,r,o,n,i.parentNode,zt,pt,i,ct),ze())},i(r){if(!l){for(let f=0;f<o.length;f+=1)G(t[f]);l=!0}},o(r){for(let f=0;f<t.length;f+=1)te(t[f]);l=!1},d(r){r&&T(i);for(let f=0;f<t.length;f+=1)t[f].d(r)}}}function un(e){let t,n;function i(){return e[30](e[54])}function l(){return e[31](e[54])}function o(...r){return e[32](e[54],...r)}function s(...r){return e[33](e[54],...r)}return t=new sn({props:{x:e[54].position.x,y:e[54].position.y,width:e[54].width||200,height:e[54].height||60,text:e[54].text,color:e[54].fill||e[3],fontSize:e[54].fontSize||16,isEditing:e[9]===e[54].id,selected:e[11]===e[54].id}}),t.$on("select",i),t.$on("delete",l),t.$on("save",o),t.$on("resize",s),{c(){Ot(t.$$.fragment)},m(r,f){$e(t,r,f),n=!0},p(r,f){e=r;const u={};f[0]&2&&(u.x=e[54].position.x),f[0]&2&&(u.y=e[54].position.y),f[0]&2&&(u.width=e[54].width||200),f[0]&2&&(u.height=e[54].height||60),f[0]&2&&(u.text=e[54].text),f[0]&10&&(u.color=e[54].fill||e[3]),f[0]&2&&(u.fontSize=e[54].fontSize||16),f[0]&514&&(u.isEditing=e[9]===e[54].id),f[0]&2050&&(u.selected=e[11]===e[54].id),t.$set(u)},i(r){n||(G(t.$$.fragment,r),n=!0)},o(r){te(t.$$.fragment,r),n=!1},d(r){et(t,r)}}}function cn(e){let t,n,i,l,o,s,r;return{c(){t=H("line"),a(t,"x1",n=e[54].points[0].x),a(t,"y1",i=e[54].points[0].y),a(t,"x2",l=e[54].points[1].x),a(t,"y2",o=e[54].points[1].y),a(t,"stroke",s=e[54].stroke||"#2f6feb"),a(t,"stroke-width",r=e[54].strokeWidth||3)},m(f,u){B(f,t,u)},p(f,u){u[0]&2&&n!==(n=f[54].points[0].x)&&a(t,"x1",n),u[0]&2&&i!==(i=f[54].points[0].y)&&a(t,"y1",i),u[0]&2&&l!==(l=f[54].points[1].x)&&a(t,"x2",l),u[0]&2&&o!==(o=f[54].points[1].y)&&a(t,"y2",o),u[0]&2&&s!==(s=f[54].stroke||"#2f6feb")&&a(t,"stroke",s),u[0]&2&&r!==(r=f[54].strokeWidth||3)&&a(t,"stroke-width",r)},i:R,o:R,d(f){f&&T(t)}}}function dn(e){let t,n,i,l;return{c(){t=H("path"),a(t,"d",n=qe(e[54].points)),a(t,"fill","none"),a(t,"stroke",i=e[54].stroke||"#2f6feb"),a(t,"stroke-width",l=e[54].strokeWidth||3),a(t,"stroke-linecap","round"),a(t,"stroke-linejoin","round")},m(o,s){B(o,t,s)},p(o,s){s[0]&2&&n!==(n=qe(o[54].points))&&a(t,"d",n),s[0]&2&&i!==(i=o[54].stroke||"#2f6feb")&&a(t,"stroke",i),s[0]&2&&l!==(l=o[54].strokeWidth||3)&&a(t,"stroke-width",l)},i:R,o:R,d(o){o&&T(t)}}}function pt(e,t){let n,i,l,o,s;const r=[dn,cn,un],f=[];function u(p,k){return p[54].kind==="freehand"?0:p[54].kind==="arrow"?1:p[54].kind==="text"?2:-1}return~(i=u(t))&&(l=f[i]=r[i](t)),{key:e,first:null,c(){n=oe(),l&&l.c(),o=oe(),this.first=n},m(p,k){B(p,n,k),~i&&f[i].m(p,k),B(p,o,k),s=!0},p(p,k){t=p;let d=i;i=u(t),i===d?~i&&f[i].p(t,k):(l&&(De(),te(f[d],1,1,()=>{f[d]=null}),ze()),~i?(l=f[i],l?l.p(t,k):(l=f[i]=r[i](t),l.c()),G(l,1),l.m(o.parentNode,o)):l=null)},i(p){s||(G(l),s=!0)},o(p){te(l),s=!1},d(p){p&&(T(n),T(o)),~i&&f[i].d(p)}}}function gt(e,t){let n,i,l,o=t[51].visible&&_t(t);return{key:e,first:null,c(){n=oe(),o&&o.c(),i=oe(),this.first=n},m(s,r){B(s,n,r),o&&o.m(s,r),B(s,i,r),l=!0},p(s,r){t=s,t[51].visible?o?(o.p(t,r),r[0]&2&&G(o,1)):(o=_t(t),o.c(),G(o,1),o.m(i.parentNode,i)):o&&(De(),te(o,1,1,()=>{o=null}),ze())},i(s){l||(G(o),l=!0)},o(s){te(o),l=!1},d(s){s&&(T(n),T(i)),o&&o.d(s)}}}function mt(e){let t,n;return{c(){t=H("path"),a(t,"d",n=qe(e[5])),a(t,"fill","none"),a(t,"stroke",e[3]),a(t,"stroke-width",e[4]),a(t,"stroke-linecap","round"),a(t,"stroke-linejoin","round")},m(i,l){B(i,t,l)},p(i,l){l[0]&32&&n!==(n=qe(i[5]))&&a(t,"d",n),l[0]&8&&a(t,"stroke",i[3]),l[0]&16&&a(t,"stroke-width",i[4])},d(i){i&&T(t)}}}function wt(e){let t,n,i,l,o;return{c(){t=H("line"),a(t,"x1",n=e[6].x),a(t,"y1",i=e[6].y),a(t,"x2",l=e[7].x),a(t,"y2",o=e[7].y),a(t,"stroke",e[3]),a(t,"stroke-width",e[4])},m(s,r){B(s,t,r)},p(s,r){r[0]&64&&n!==(n=s[6].x)&&a(t,"x1",n),r[0]&64&&i!==(i=s[6].y)&&a(t,"y1",i),r[0]&128&&l!==(l=s[7].x)&&a(t,"x2",l),r[0]&128&&o!==(o=s[7].y)&&a(t,"y2",o),r[0]&8&&a(t,"stroke",s[3]),r[0]&16&&a(t,"stroke-width",s[4])},d(s){s&&T(t)}}}function bt(e){let t,n,i,l,o;return{c(){t=H("rect"),a(t,"x",n=e[8].x),a(t,"y",i=e[8].y),a(t,"width",l=e[8].w),a(t,"height",o=e[8].h),a(t,"fill","none"),a(t,"stroke",e[3]),a(t,"stroke-dasharray","4 4")},m(s,r){B(s,t,r)},p(s,r){r[0]&256&&n!==(n=s[8].x)&&a(t,"x",n),r[0]&256&&i!==(i=s[8].y)&&a(t,"y",i),r[0]&256&&l!==(l=s[8].w)&&a(t,"width",l),r[0]&256&&o!==(o=s[8].h)&&a(t,"height",o),r[0]&8&&a(t,"stroke",s[3])},d(s){s&&T(t)}}}function hn(e){let t,n,i,l,o,s,r,f,u,p,k,d,m,_,y,v,j,L,z,U,Y,D,g,S,c,I,P,le,se,E,q,V,Q,de,ie,fe,he,x,ke,J,Z,F,ve,Le,K=!e[12]&&dt();const Oe=[fn,an],re=[];function Pe(O,W){return O[0]?0:1}return J=Pe(e),Z=re[J]=Oe[J](e),{c(){t=N("div"),n=N("div"),i=N("div"),l=N("button"),o=ee("Select"),r=$(),f=N("button"),u=ee("Arrow"),k=$(),d=N("button"),m=ee("Draw"),y=$(),v=N("button"),j=ee("Text"),z=$(),U=N("button"),Y=ee("Eraser"),g=$(),S=N("div"),c=N("label"),I=ee("Color "),P=N("input"),se=$(),E=N("label"),q=ee("Width "),V=N("input"),de=$(),ie=N("input"),he=$(),x=N("div"),K&&K.c(),ke=$(),Z.c(),l.disabled=s=!e[12],f.disabled=p=!e[12],d.disabled=_=!e[12],v.disabled=L=!e[12],U.disabled=D=!e[12],a(P,"type","color"),P.disabled=le=!e[12],a(V,"type","number"),a(V,"min","1"),a(V,"max","12"),V.disabled=Q=!e[12],b(V,"width","60px"),b(S,"display","flex"),b(S,"gap","10px"),b(S,"align-items","center"),b(S,"padding-left","16px"),a(ie,"class","image-input svelte-1n3uqbm"),a(ie,"type","file"),a(ie,"accept","image/*"),ie.disabled=fe=!e[12],a(n,"class","toolbar svelte-1n3uqbm"),a(x,"class","stage-wrap svelte-1n3uqbm"),a(t,"class","board-root svelte-1n3uqbm")},m(O,W){B(O,t,W),w(t,n),w(n,i),w(i,l),w(l,o),w(i,r),w(i,f),w(f,u),w(i,k),w(i,d),w(d,m),w(i,y),w(i,v),w(v,j),w(i,z),w(i,U),w(U,Y),w(n,g),w(n,S),w(S,c),w(c,I),w(c,P),be(P,e[3]),w(S,se),w(S,E),w(E,q),w(E,V),be(V,e[4]),w(n,de),w(n,ie),w(t,he),w(t,x),K&&K.m(x,null),w(x,ke),re[J].m(x,null),F=!0,ve||(Le=[C(l,"click",e[22]),C(f,"click",e[23]),C(d,"click",e[24]),C(v,"click",e[25]),C(U,"click",e[26]),C(P,"input",e[27]),C(V,"input",e[28]),C(ie,"change",e[14])],ve=!0)},p(O,W){(!F||W[0]&4096&&s!==(s=!O[12]))&&(l.disabled=s),(!F||W[0]&4096&&p!==(p=!O[12]))&&(f.disabled=p),(!F||W[0]&4096&&_!==(_=!O[12]))&&(d.disabled=_),(!F||W[0]&4096&&L!==(L=!O[12]))&&(v.disabled=L),(!F||W[0]&4096&&D!==(D=!O[12]))&&(U.disabled=D),(!F||W[0]&4096&&le!==(le=!O[12]))&&(P.disabled=le),W[0]&8&&be(P,O[3]),(!F||W[0]&4096&&Q!==(Q=!O[12]))&&(V.disabled=Q),W[0]&16&&It(V.value)!==O[4]&&be(V,O[4]),(!F||W[0]&4096&&fe!==(fe=!O[12]))&&(ie.disabled=fe),O[12]?K&&(K.d(1),K=null):K||(K=dt(),K.c(),K.m(x,ke));let Ae=J;J=Pe(O),J===Ae?re[J].p(O,W):(De(),te(re[Ae],1,1,()=>{re[Ae]=null}),ze(),Z=re[J],Z?Z.p(O,W):(Z=re[J]=Oe[J](O),Z.c()),G(Z,1),Z.m(x,null))},i(O){F||(G(Z),F=!0)},o(O){te(Z),F=!1},d(O){O&&T(t),K&&K.d(),re[J].d(),ve=!1,ne(Le)}}}const _n=15e3,pn=12e3,gn=1200,yt=20;function Ye(e){return`${e}_${Date.now()}_${Math.random().toString(36).slice(2,8)}`}function qe(e){if(e.length===0)return"";const[t,...n]=e;return`M ${t.x} ${t.y} `+n.map(i=>`L ${i.x} ${i.y}`).join(" ")}function Je(e){const t=e.currentTarget.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}function kt(e,t,n){const i=n.x-t.x,l=n.y-t.y,o=e.x-t.x,s=e.y-t.y,r=i*o+l*s;if(r<=0)return Math.hypot(e.x-t.x,e.y-t.y);const f=i*i+l*l;if(f<=r)return Math.hypot(e.x-n.x,e.y-n.y);const u=r/f,p={x:t.x+u*i,y:t.y+u*l};return Math.hypot(e.x-p.x,e.y-p.y)}function mn(e,t,n=8){if(e.kind==="freehand"){const i=e.points;for(let l=1;l<i.length;l++)if(kt(t,i[l-1],i[l])<=(e.strokeWidth||3)+n)return!0;return!1}if(e.kind==="arrow"){const[i,l]=e.points;return kt(t,i,l)<=(e.strokeWidth||3)+n}if(e.kind==="text"){const i=t.x-e.position.x,l=t.y-e.position.y;return Math.hypot(i,l)<=10+n}return!1}function wn(e,t,n){let i,l,o;He(e,me,h=>n(13,i=h)),He(e,Me,h=>n(0,l=h)),He(e,Ie,h=>n(1,o=h));let{docId:s}=t,{currentUser:r}=t,{storageAdapter:f}=t,{lockAdapter:u}=t,p=null,k="#2f6feb",d=3,m=null,_=[],y=null,v=null,j=!1,L=null,z=null,U=null,Y="",D=null,g=!1,S,c,I=!1,P,le;function se(){g&&(clearTimeout(le),le=setTimeout(de,gn))}async function E(){var h;try{const A=await f.getDocument(s).catch(()=>Qt(s,r));Xe(A),P=(h=A.image)==null?void 0:h.dataUrl,await q()}catch(A){console.error(A)}}async function q(){try{(await u.acquire(s,r.id)).ok?(n(12,g=!0),V()):(n(12,g=!1),Q())}catch(h){console.error(h),n(12,g=!1),Q()}}function V(){clearInterval(c),clearInterval(S),S=setInterval(async()=>{try{(await u.renew(s,r.id)).ok||(n(12,g=!1),clearInterval(S),Q())}catch(h){console.warn("renew failed",h)}},_n)}function Q(){clearInterval(S),clearInterval(c),c=setInterval(async()=>{var h;try{if(!(await u.get(s)).locked)clearInterval(c),await q();else{const M=await f.getDocument(s);Xe(M),P=(h=M.image)==null?void 0:h.dataUrl}}catch{}},pn)}async function de(){var h,A;if(!(!g||I)){I=!0;try{const M=xt(s,r.id);((h=M.image)==null?void 0:h.dataUrl)===P&&(M.image=void 0);const{version:X}=await f.saveDocument(s,M,M.version);it.set(X),M.image&&M.image.dataUrl&&(P=M.image.dataUrl)}catch(M){if(M.message==="version_conflict"){const X=await f.getDocument(s);Xe(X),P=(A=X.image)==null?void 0:A.dataUrl,n(12,g=!1),Q()}else console.error(M)}finally{I=!1}}}async function ie(h){var Ne;const M=(Ne=h.target.files)==null?void 0:Ne[0];if(!M)return;const{dataUrl:X,width:ae,height:_e}=await tn(M),Ue=Date.now();Me.set({dataUrl:X,width:ae,height:_e,updatedAt:Ue,updatedBy:r.id}),P=void 0,se()}function fe(){let h=[];Ie.subscribe(M=>h=M)();const A=h.find(M=>M.visible)||h[0];return(A==null?void 0:A.id)??null}function he(h){Ce(A=>A.map(M=>M.id===h.layerId?{...M,shapes:[...M.shapes,h]}:M))}function x(h){const A=fe();A&&Ce(M=>M.map(X=>X.id===A?{...X,shapes:X.shapes.filter(ae=>!mn(ae,h))}:X))}function ke(h){if(!g||(i==="select"&&n(11,D=null),m=fe(),!m))return;j=!0;const A=Je(h);if(n(7,v=A),i==="draw")n(5,_=[A]);else if(i==="arrow")n(6,y=A);else if(i==="text"){if(U){j=!1;return}L=A,n(8,z={x:A.x,y:A.y,w:0,h:0})}else i==="erase"&&x(A)}function J(h){if(!g||!j)return;const A=Je(h);if(n(7,v=A),i==="draw")n(5,_=[..._,A]);else if(i==="text"&&L){const M=Math.min(L.x,A.x),X=Math.min(L.y,A.y),ae=Math.abs(A.x-L.x),_e=Math.abs(A.y-L.y);n(8,z={x:M,y:X,w:ae,h:_e})}else i==="erase"&&x(A)}function Z(h){if(!g)return;const A=Je(h);if(i==="draw"&&_.length>1&&m){const M={id:Ye("fh"),kind:"freehand",layerId:m,createdAt:Date.now(),createdBy:r.id,updatedAt:Date.now(),points:_,stroke:k,strokeWidth:d};he(M)}else if(i==="arrow"&&y&&m){const M={id:Ye("arr"),kind:"arrow",layerId:m,createdAt:Date.now(),createdBy:r.id,updatedAt:Date.now(),points:[y,A],stroke:k,strokeWidth:d,arrowHead:"triangle"};he(M)}else if(i==="text"&&L&&m){const M=Math.min(L.x,A.x),X=Math.min(L.y,A.y),ae=Math.abs(A.x-L.x),_e=Math.abs(A.y-L.y);if(ae>=yt&&_e>=yt){const Ue=Ye("txt"),Ne={id:Ue,kind:"text",layerId:m,createdAt:Date.now(),createdBy:r.id,updatedAt:Date.now(),position:{x:M,y:X},text:"",fontSize:16,fill:k,width:ae,height:_e};he(Ne),n(9,U=Ue),n(10,Y="")}}n(5,_=[]),n(6,y=null),n(7,v=null),j=!1,L=null,n(8,z=null)}Mt(()=>{E()}),qt(async()=>{if(clearInterval(S),clearInterval(c),g)try{await u.release(s,r.id)}catch{}});const F=()=>me.set("select"),ve=()=>me.set("arrow"),Le=()=>me.set("draw"),K=()=>me.set("text"),Oe=()=>me.set("erase");function re(){k=this.value,n(3,k)}function Pe(){d=It(this.value),n(4,d)}function O(h){Re[h?"unshift":"push"](()=>{p=h,n(2,p)})}const W=h=>{i==="select"&&n(11,D=h.id)},Ae=h=>{$t(h.layerId,h.id),n(11,D=null)},Pt=(h,A)=>{at(h.layerId,{...h,text:A.detail.text,updatedAt:Date.now()}),n(9,U=null),n(10,Y="")},Ut=(h,A)=>{at(h.layerId,{...h,width:A.detail.width,height:A.detail.height,updatedAt:Date.now()})};return e.$$set=h=>{"docId"in h&&n(18,s=h.docId),"currentUser"in h&&n(19,r=h.currentUser),"storageAdapter"in h&&n(20,f=h.storageAdapter),"lockAdapter"in h&&n(21,u=h.lockAdapter)},e.$$.update=()=>{e.$$.dirty[0]&2&&se(),e.$$.dirty[0]&1&&se()},[l,o,p,k,d,_,y,v,z,U,Y,D,g,i,ie,ke,J,Z,s,r,f,u,F,ve,Le,K,Oe,re,Pe,O,W,Ae,Pt,Ut]}class bn extends nt{constructor(t){super(),tt(this,t,wn,hn,We,{docId:18,currentUser:19,storageAdapter:20,lockAdapter:21},null,[-1,-1])}}function vt(e){return`markup:doc:${e}`}function At(e){return`markup:versions:${e}`}function yn(){return{storageAdapter:{async getDocument(n){const i=localStorage.getItem(vt(n));if(!i)throw new Error("not_found");return JSON.parse(i)},async saveDocument(n,i,l){let o;try{o=await this.getDocument(n)}catch{}const s={...o??i,...i,image:i.image??(o==null?void 0:o.image),version:((o==null?void 0:o.version)??0)+1,updatedAt:Date.now()};return localStorage.setItem(vt(n),JSON.stringify(s)),{version:s.version}},async listVersions(n){const i=localStorage.getItem(At(n));return i?JSON.parse(i):[]},async saveVersion(n,i){const l=await this.listVersions(n),o=`${n}-${Date.now()}`,s={...i,id:o};return localStorage.setItem(At(n),JSON.stringify([s,...l])),{versionId:o}}},lockAdapter:{async acquire(){return{ok:!0,expiresAt:Date.now()+6e4}},async renew(){return{ok:!0}},async release(){return{ok:!0}},async get(){return{locked:!1}}}}}function kn(e){let t,n,i,l,o,s;return o=new bn({props:{docId:vn,currentUser:e[2],storageAdapter:e[0],lockAdapter:e[1]}}),{c(){t=N("div"),n=N("header"),n.innerHTML="<strong>Markup Prototype</strong>",i=$(),l=N("main"),Ot(o.$$.fragment),b(n,"display","flex"),b(n,"align-items","center"),b(n,"gap","12px"),b(n,"padding","8px 12px"),b(n,"border-bottom","1px solid var(--color-border)"),b(n,"background","var(--color-surface)"),b(t,"height","100vh"),b(t,"display","grid"),b(t,"grid-template-rows","auto 1fr")},m(r,f){B(r,t,f),w(t,n),w(t,i),w(t,l),$e(o,l,null),s=!0},p:R,i(r){s||(G(o.$$.fragment,r),s=!0)},o(r){te(o.$$.fragment,r),s=!1},d(r){r&&T(t),et(o)}}}const vn="prototype-doc";function An(e){const{storageAdapter:t,lockAdapter:n}=yn();return[t,n,{id:"demo",name:"Demo"}]}class Sn extends nt{constructor(t){super(),tt(this,t,An,kn,We,{})}}new Sn({target:document.getElementById("app")});
